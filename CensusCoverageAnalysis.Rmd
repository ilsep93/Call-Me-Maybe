---
title: "Call Me Maybe: Noncoverage error in Mexican cell-phone surveys"
author: "Ilse Paniagua"
date: "1/17/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(haven)
library(data.table)
library(dtplyr)
library(magrittr)
library(janitor)
library(dplyr)
library(recipes)
library(stringr)
library(ggplot2)
library(readr)
library(forcats)
```

### Reading datasets

```{r}
#Population totals per state, for post-stratification adjustments
#iter <- read.dbf(file="ITER_NALDBF10.dbf")
hh <- as.data.table(read_stata(file="DUMMY_VIVIENDAS.dta")) %>%
  janitor::clean_names()
```
I will use the ITER data to get population level estimates of cellphone and landline coverage. The microdata at the household level will be used to estimate coverage error.

Defining %ni% function.
```{r}
'%ni%' <- Negate('%in%')
```


# Data Cleaning: Household-Level Data

```{r}
#Keeping only variables for analysis
#Converting the key variables from character to numeric
hh_df <- hh %>% as.data.frame()

hh_df %<>% select(!!c(2, 8, 13:29, 34, 36)) %>%
  mutate_if(is.character, as.numeric)

#Recoding to 1 or 0
hh_df %<>%
  mutate_at(.vars = vars(electri, sersan, radio, refrig, autoprop, telefono, internet), funs(recode(., `2`=0, `3`=0))) %>%
  mutate_at(.vars = vars(televi, lavadora, compu, celular), funs(recode(., `3`=1, `4`=0)))

#Recoding 9 and 99 to missing
hh_df %<>%
  mutate_at(.vars = vars(telefono, celular, internet, tipohog, pisos, electri, disagu, conagu, drenaje, radio, televi, telefono, refrig, sersan, lavadora, compu), funs(na_if(., 9))) %>%
  mutate_at(.vars = vars(cuadorm, totcuart), funs(na_if(., 99)))

#Recoding to factor
hh_df %<>%
  mutate_at(.vars = vars(conagu, disagu, drenaje, tipohog, pisos), funs(as.factor))

#Making dummy variables for continous variables
hh_df <- recipe(id_viv ~., data=hh_df) %>%
  step_dummy(conagu, one_hot=TRUE) %>%
  step_dummy(disagu, one_hot=TRUE) %>%
  step_dummy(drenaje, one_hot=TRUE) %>%
  step_dummy(tipohog, one_hot=TRUE) %>%
  step_dummy(pisos, one_hot=TRUE) %>%
  prep(training=hh_df) %>%
  bake(new_data = hh_df)
```

# Population: Household Summary Statistics

ENT 14 is Jalisco
ENT 21 is Puebla

I need a table with summary statistics for each of the questions, by state.

I will calculate the mean, standard error, and number of responses for each survey estimate.

```{r}
pop_hh <- hh_df %>%
  select(-id_viv) %>%
  group_by(ent) %>%
  summarise_all(funs(mean = mean(.,na.rm=T), n = sum(!is.na(.)), var = var(., na.rm=T), se = sd(., na.rm=T)/sqrt(sum(!is.na(.))))) %>%
  t() %>%
  as.data.frame()
  
colnames(pop_hh) <- c("Jalisco", "Puebla")

setDT(pop_hh, keep.rownames = "variable")

pop_hh %<>% arrange(variable)
  
```

## Household: Cell-only

Household-level summary statistics for households with a cell-phone.
```{r}
hh_cell_only <- hh_df %>%
  select(-id_viv) %>%
  filter(celular==1) %>%  
  group_by(ent) %>%
  summarise_all(funs(mean = mean(.,na.rm=T), n = sum(!is.na(.)), var = var(., na.rm=T), se = sd(., na.rm=T)/sqrt(sum(!is.na(.))))) %>%
  t() %>%
  as.data.frame()
  
colnames(hh_cell_only) <- c("Jalisco", "Puebla")

setDT(hh_cell_only, keep.rownames = "variable")

hh_cell_only %<>% arrange(variable)
  
```

# Data Cleaning: Individual-Level Data

```{r}
pp <- as.data.table(read_stata(file="DUMMY_PERSONAS.dta")) %>%
  janitor::clean_names()
```


Selecting only variables of interest.
```{r}
pp_df <- pp %>% select(!!c(2,11:13, 17:21, 28, 32:35, 38, 40, 46)) %>%
  mutate_if(is.character, as.numeric)
```

Recoding data and assigning missing values.
```{r}
#Recoding to 1 or 0
pp_df %<>%
  mutate_at(.vars = vars(sexo, asisten, alfabet, hlengua), funs(recode(., `2`=0, `3`=0))) %>%
  mutate_at(.vars = vars(), funs(recode(., `3`=1, `4`=0))) %>%
  #Recoding all married statuses to be same
  mutate_at(.vars = vars(estcon), funs(recode(., `6`=5, `7`=5))) %>%
  #Discapacitado variables
  mutate_at(.vars = vars(discap1), funs(recode(., `10`=1))) %>%
    mutate_at(.vars = vars(discap2), funs(recode(., `11`=1)))

#Recoding 9 and 99 to missing
pp_df %<>%
  mutate_at(.vars = vars(dhsersal1, dhsersal2, alfabet, estcon, asisten, hlengua), funs(na_if(., 9))) %>%
  mutate_at(.vars = vars(escolari, nivacad, numhij), funs(na_if(., 99))) %>%
  mutate_at(.vars = vars(edad, edad_jefe), funs(na_if(., 999))) %>%
  mutate_at(.vars = vars(numhij), funs(na_if(., 98)))

#Discap NA to 0
pp_df %<>%
  mutate_at(.vars = vars(discap1, discap2), funs(replace(., is.na(.),0)))

#Recoding dhsersal, if one is 1 then both are 1
pp_df %<>%
  mutate(dhsersal_imss = case_when(
    dhsersal1==1 | dhsersal2 == 1 ~ 1,
    TRUE ~ 0),
    dhsersal_isste = case_when(
    dhsersal1==3 | dhsersal1 ==3 ~ 1,
    dhsersal2==4 | dhsersal2==4 ~ 1,
    TRUE ~ 0)) %>%
    mutate(dhsersal_private = case_when(
      dhsersal1==5 | dhsersal2==5 ~ 1,
      TRUE ~ 0)) %>%
    mutate(dhsersal_noinsu = case_when(
      dhsersal1==8 | dhsersal2==8 ~ 1,
      TRUE ~ 0))

#Creating education variables
pp_df %<>%
  mutate(primary = case_when(
    nivacad==2 | nivacad==6 ~ 1,
    TRUE ~ 0)) %>%
  mutate(secondary = case_when(
    nivacad==3 | nivacad==7 ~ 1,
    TRUE ~ 0)) %>%
  mutate(highschool = case_when(
    nivacad==4 | nivacad==8 ~ 1,
    TRUE ~ 0))

#Removing unnecessary variables
pp_df %<>% select(-dhsersal1, -dhsersal2, -otrarel_c, -escolari, -nivacad, -estcon)
```

```{r}
summary(pp_df)
```

## Population: Individual Summary Statistics

Table with summary statistics for each of the questions, by state.

```{r}
pop_ind <- hh_df %>%
  select(id_viv, ent, celular) %>% 
  inner_join(pp_df, by = c("id_viv" , "ent")) %>%
  select(-id_viv) %>%
  group_by(ent) %>%
  summarise_all(funs(mean = mean(.,na.rm=T), n = sum(!is.na(.)), var = var(., na.rm=T), se = sd(., na.rm=T)/sqrt(sum(!is.na(.))))) %>%
    t() %>%
  as.data.frame()

colnames(pop_ind) <- c("Jalisco", "Puebla")

setDT(pop_ind, keep.rownames = "variable")

pop_ind %<>% arrange(variable)
#All obs join
#anti_join(hh_df, pp_df, by="id_viv")
```

## Individual: Cell-phone statistics

I have to merge the individual and household datasets to see which individuals are in a household with a cellphone.

```{r}
pp_cell_only <- hh_df %>%
  select(id_viv, ent, celular) %>% 
  inner_join(pp_df, by = c("id_viv" , "ent")) %>%
  filter(celular==1) %>%
  select(-id_viv) %>%
  group_by(ent) %>%
  summarise_all(funs(mean = mean(.,na.rm=T), n = sum(!is.na(.)), var = var(., na.rm=T), se = sd(., na.rm=T)/sqrt(sum(!is.na(.))))) %>%
  t() %>%
  as.data.frame()

colnames(pp_cell_only) <- c("Jalisco", "Puebla")

setDT(pp_cell_only, keep.rownames = "variable")

pp_cell_only %<>% arrange(variable)
#All obs join
#anti_join(hh_df, pp_df, by="id_viv")
```

# Household: Difference of means

I now calculate the difference in survey statistics between households with a cell-phone and the general population, by state.
```{r}
#Joining means for population and cell-only
hh_diff_means <- bind_cols (
  pop_hh,
  hh_cell_only
) %>%
  select(-variable1) %>%
  filter(variable %ni% c("ent, ent1")) %>%
  #Renaming variables for clarity
  rename(jalisco_pop = Jalisco, puebla_pop= Puebla, jalisco_cell = Jalisco1, puebla_cell= Puebla1) %>%
  #Keep only means
  filter(grepl("mean", variable)) %>%
  mutate(diff_jalisco = jalisco_cell- jalisco_pop,
         diff_puebla = puebla_cell - puebla_pop)
  
```

I also calculate the standard error of the difference. The formula is:

$SE_{cell - pop} = \sqrt{\frac{\sigma^2_{cell}}{n_{cell}} + \frac{\sigma^2_{pop}}{n_{pop}}} $

Number of observations:
n_pop_jalisco/puebla =143090
n_jalisco_cell=91646
n_puebla_cell=91631

```{r}
#Standard error of difference
hh_diff_se <- bind_cols (
  pop_hh,
  hh_cell_only
) %>%
  select(-variable1) %>%
  #Renaming variables for clarity
  rename(jalisco_pop = Jalisco, puebla_pop= Puebla, jalisco_cell = Jalisco1, puebla_cell= Puebla1) %>%
  #Keep only means
  filter(grepl("var", variable)) %>%
  mutate(diff_se_jalisco = sqrt((jalisco_cell/91646) + (jalisco_pop/143090)),
        diff_se_puebla = sqrt((puebla_cell/91631) + (puebla_pop/143090)))

```

# Individual: Difference of means

```{r}
pp_diff_means <- bind_cols (
  pop_ind,
  pp_cell_only
) %>%
  select(-variable1) %>%
  filter(variable %ni% c("ent", "ent1")) %>%
  #Renaming variables for clarity
  rename(jalisco_pop = Jalisco, puebla_pop= Puebla, jalisco_cell = Jalisco1, puebla_cell= Puebla1) %>%
  #Keep only means
  filter(grepl("mean", variable)) %>%
  mutate(diff_jalisco = jalisco_cell- jalisco_pop,
         diff_puebla = puebla_cell - puebla_pop)
```

n_jalisco_pop=561243
n_puebla_pop=561309
n_jalisco_cell=362540
n_puebla_cell=363192
```{r}
#Standard error of difference
pp_diff_se <- bind_cols (
  pop_ind,
  pp_cell_only
) %>%
  select(-variable1) %>%
  filter(variable %ni% c("ent", "ent1")) %>%
  #Renaming variables for clarity
  rename(jalisco_pop = Jalisco, puebla_pop= Puebla, jalisco_cell = Jalisco1, puebla_cell= Puebla1) %>%
  #Keep only means
  filter(grepl("var", variable)) %>%
  mutate(diff_se_jalisco = sqrt((jalisco_cell/362540) + (jalisco_pop/561243)),
        diff_se_puebla = sqrt((puebla_cell/363192) + (puebla_pop/561309)))

```

## Household and Individual: Standard error of means

```{r}
#Standard error of means
 means_se <- bind_cols (
  pop_ind,
  pp_cell_only,
) %>%
  select(-variable1) %>%
  filter(variable %ni% c("ent", "ent1")) %>%
  #Renaming variables for clarity
  rename(se_jalisco_pop = Jalisco, se_puebla_pop= Puebla, se_jalisco_cell = Jalisco1, se_puebla_cell= Puebla1) %>%
  #Keep only means
  filter(grepl("_se", variable)) %>%
  bind_rows(
     bind_cols (
  pop_hh,
  hh_cell_only,
) %>%
  select(-variable1) %>%
  filter(variable %ni% c("ent", "ent1")) %>%
  #Renaming variables for clarity
  rename(se_jalisco_pop = Jalisco, se_puebla_pop= Puebla, se_jalisco_cell = Jalisco1, se_puebla_cell= Puebla1) %>%
  #Keep only means
  filter(grepl("_se", variable))
  ) %>% mutate_at(.vars=vars(variable),funs(str_replace_all(.,"_se", "")))
```


# Final tables

```{r}
#Combining differences of means and se of differences
table2 <- bind_rows(
  
  bind_cols(
  pp_diff_means,
  pp_diff_se
) %>%
  select(-variable1, -jalisco_pop1, -puebla_pop1, -jalisco_cell1, -puebla_cell1)

,

bind_cols(
  hh_diff_means,
  hh_diff_se
) %>%
  select(-variable1, -jalisco_pop1, -puebla_pop1, -jalisco_cell1, -puebla_cell1)

)
```

Rerranging variable order.
I am also removing cell-phone ownership from the table.
```{r}
#Renaming variables
table2 %<>%
  mutate_at(.vars=vars(variable),funs(str_replace_all(.,"_mean", "")))
```

```{r}
table2 %<>%
  mutate(order = case_when(
    #Demographics
    variable=="sexo" ~ 1,
    variable=="edad" ~ 2,
    variable=="edad_jefe" ~ 3,
    variable=="numpers" ~ 4,
    variable=="numhij" ~ 5,
    variable=="totcuart" ~ 6,
    variable=="cuadorm" ~ 7,
    variable=="hlengua" ~ 8,
    #Education
    variable=="alfabet" ~ 9,
    variable=="asisten" ~ 10,
    variable=="primary" ~ 11,
    variable=="secondary" ~ 12,
    variable=="highschool" ~ 13,
    #Health Insurance
    variable=="dhsersal_imss" ~ 14,
    variable=="dhsersal_isste" ~ 15,
    variable=="dhsersal_private" ~ 16,
    variable=="dhsersal_noinsu" ~ 17,
    #Asset Ownership
    variable=="electri" ~ 18,
    variable=="radio" ~ 19,
    variable=="televi" ~ 20,
    variable=="refri" ~ 21,
    variable=="lavadora" ~ 22,
    variable=="autoprop" ~ 23,
    variable=="compu" ~ 24,
    variable=="telefono" ~ 25,
    variable=="sersan" ~ 26,
    #variable=="celular" ~ 27,
    variable=="internet" ~ 28,
    #Type of Home
    variable=="tipohog_X1" ~ 29,
    variable=="tipohog_X2" ~ 30,
    variable=="tipohog_X3" ~ 31,
    variable=="tipohog_X4" ~ 32,
    variable=="tipohog_X5" ~ 33,
    variable=="tipohog_X6" ~ 34,
    #Type of Flooring
    variable=="pisos_X1" ~ 35,
    variable=="pisos_X2" ~ 36,
    variable=="pisos_X3" ~ 37,
    #Waste Disposal (conagu)
    variable=="conagu_X5" ~ 38,
    variable=="conagu_X6" ~ 39,
    variable=="conagu_X6" ~ 40,
    #Drainage
    variable=="drenaje_X1" ~ 41,
    variable=="drenaje_X2" ~ 42,
    variable=="drenaje_X3" ~ 43,
    variable=="drenaje_X4" ~ 44,
    variable=="drenaje_X5" ~ 45,
    TRUE ~ 0
  )) %>% filter(!order==0) %>% arrange(order)
```

Adding standard error of means to table.
```{r}
table2 %<>%
  left_join(means_se, by="variable")
```
Rearranging variables.
```{r}
table2 %<>%
  select(variable, jalisco_pop, se_jalisco_pop, puebla_pop, se_puebla_pop, jalisco_cell, se_jalisco_cell, puebla_cell, se_puebla_cell, diff_jalisco, diff_se_jalisco, diff_puebla, diff_se_puebla)
```


Multiplying proportions by 100. This is easier to do if variables are columns instead of rows. This also allows me to place standard errors directly below means.

```{r}
test <- table2 %>%
  t() %>%
  as_tibble()

names(test) <- test[1,]

test <- test[-c(1,14),]

test %<>%
  mutate_all(funs(as.numeric)) %>%
  mutate_at(vars(hlengua:drenaje_X5),
            .funs = funs(. * 100)) %>%
    mutate_at(vars(sexo),
            .funs = funs(. * 100)) %>%
  mutate_all(round, 3)

row.names(test) <- (c("jalisco_pop", "se_jalisco_pop", "puebla_pop", "se_puebla_pop", "jalisco_cell", "se_jalisco_cell", "puebla_cell", "se_puebla_cell", "diff_jalisco", "diff_se_jalisco", "diff_puebla", "diff_se_puebla"))
```

## Testing normality of the data

t-tests require that the data be normally distributed. I will test this with the Kolmogorov-Smirnov test. This is because the Shapiro-Wilk test requires fewer than 5,000 obs. and may be oversensitive to small deviations in normality.

```{r}
#KS test for each variable in household dataset
normality_test <- list()

for(i in seq(dim(hh_df)[2])) {
  result <- append(result, ks.test((hh_df[[i]]), y='pnorm', alternative='two.sided'))
}

print(normality_test)
```

```{r}
#Normal Q-Q Plot for number of people in HH
qqnorm(hh_df$numpers)
```
Results show that most variables are not normally distributed. Since t-tests assume that the variables are normally distributed, I will perform a non-parametric Wilcoxon rank sum test.

# Wilcox test for difference in means
```{r}
wilcox.test(hh_df$totcuart ~ hh_df$celular, df=hh_df)
```


To do:
-populate table with se at the bottom of means
- wilcox for difference of means
-jalisco and puebla demographic comparison to national averages
-post-stratification weighting adjustments

# Cell-Phone Ownership Statistics

Cellphone ownership in Puebla and Jalisco (source: 2010 Mexican Census)

```{r}
#Table 1: Cell-phone ownership
hh_df %>%
  group_by(ent) %>%
  summarise(cell_mean = mean(celular, na.rm=T) * 100,
            cell_se = sqrt(mean(celular, na.rm=T) * (1-(mean(celular, na.rm=T)))/length(celular)) * 100) %>%
  mutate_all(round, 2)
```

Cell-phone ownership 2005-2018, overall and by age (source: Latinobarometro).

```{r}
latino <- read_csv(file="Latinobarometro_CellPhone_byAge.csv") %>%
    mutate(Age = fct_recode(Age,
                          "61+" = "61"))
```


```{r}
latino %>%
  ggplot(aes(x=Year, y=Yes, linetype=fct_relevel(Age, "Overall"), label=Yes)) +
  geom_line() +
  theme_light() +
  labs(title="Figure 1: Household cell-phone ownership 2005-2018, by age group",
       y="Owns cell-phone (%)",
       caption="Source: Latinobarometro",
       linetype="Age Group") +
  scale_y_continuous(breaks=seq(0,100, by=10)) +
  scale_x_continuous(breaks=seq(2006,2018, by=2)) +
  geom_label(data=subset(latino, Age=="Overall" & Year %in% c(2005, 2010, 2018)))
```

